<html>
<head>
<title>CameraActivity.java</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.ln { color: #606366; font-weight: normal; font-style: normal; }
.s0 { color: rgb(204,120,50); }
.s1 { color: rgb(169,183,198); }
.s2 { color: rgb(104,151,187); }
.s3 { color: rgb(128,128,128); }
.s4 { color: rgb(106,135,89); }
</style>
</head>
<BODY BGCOLOR="#2b2b2b">
<TABLE CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<TR><TD><CENTER>
<FONT FACE="Arial, Helvetica" COLOR="#000000">
CameraActivity.java</FONT>
</center></TD></TR></TABLE>
<pre>
<span class="s0">package </span><span class="s1">developer.tuyen.liveedusupporter</span><span class="s0">;</span><span class="s1"> 
 
</span><span class="s0">import </span><span class="s1">android.Manifest</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.content.Context</span><span class="s0">;</span><span class="s1"> 
 
</span><span class="s0">import </span><span class="s1">android.content.pm.PackageManager</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.graphics.ImageFormat</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.graphics.SurfaceTexture</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.hardware.camera2.CameraAccessException</span><span class="s0">;</span><span class="s1"> 
 
</span><span class="s0">import </span><span class="s1">android.hardware.camera2.CameraCaptureSession</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.hardware.camera2.CameraCharacteristics</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.hardware.camera2.CameraDevice</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.hardware.camera2.CameraManager</span><span class="s0">;</span><span class="s1"> 
 
</span><span class="s0">import </span><span class="s1">android.hardware.camera2.CaptureRequest</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.hardware.camera2.CaptureResult</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.hardware.camera2.TotalCaptureResult</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.hardware.camera2.params.StreamConfigurationMap</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.media.Image</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.media.ImageReader</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.media.MediaRecorder</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.os.Build</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.os.Environment</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.os.Handler</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.os.HandlerThread</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.os.SystemClock</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.support.annotation.NonNull</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.support.v4.content.ContextCompat</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.support.v7.app.AppCompatActivity</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.os.Bundle</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.util.Size</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.util.SparseIntArray</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.view.Surface</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.view.TextureView</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.view.View</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.widget.Button</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.widget.Chronometer</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.widget.ImageButton</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.widget.Toast</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">java.io.*</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">java.io.IOException</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">java.nio.ByteBuffer</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">java.text.SimpleDateFormat</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">java.util.ArrayList</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">java.util.Arrays</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">java.util.Collections</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">java.util.Comparator</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">java.util.Date</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">java.util.List</span><span class="s0">;</span><span class="s1"> 
 
</span><span class="s0">public class </span><span class="s1">CameraActivity </span><span class="s0">extends </span><span class="s1">AppCompatActivity { 
    </span><span class="s0">private static final int </span><span class="s1">REQUEST_CAMERA_PERMISSION_RESULT=</span><span class="s2">0</span><span class="s0">;</span><span class="s1"> 
    </span><span class="s0">private static final int </span><span class="s1">REQUEST_WRITE_EXTENAL_STORAGE_PERMISSION_RESULT=</span><span class="s2">1</span><span class="s0">;</span><span class="s1"> 
    </span><span class="s0">private static final int </span><span class="s1">STATE_PREVIEW=</span><span class="s2">0</span><span class="s0">;</span><span class="s1"> 
    </span><span class="s0">private static final int </span><span class="s1">STATE_WAIT_LOCK=</span><span class="s2">1</span><span class="s0">;</span><span class="s1"> 
    </span><span class="s0">private  int </span><span class="s1">mCaptureState=STATE_PREVIEW</span><span class="s0">;</span><span class="s1"> 
    TextureView textureView</span><span class="s0">;</span><span class="s1"> 
    </span><span class="s0">private </span><span class="s1">Button btn_OpenCamera</span><span class="s0">;</span><span class="s1"> 
    </span><span class="s0">private </span><span class="s1">CameraDevice mCameraDevice</span><span class="s0">;</span><span class="s1"> 
    </span><span class="s0">private </span><span class="s1">CaptureRequest.Builder captureRequestBuilder</span><span class="s0">;</span><span class="s1"> 
    String mCameraID</span><span class="s0">;</span><span class="s1"> 
    CameraManager cameraManager</span><span class="s0">;</span><span class="s1"> 
    HandlerThread handlerThread</span><span class="s0">;</span><span class="s1"> 
    Handler handler</span><span class="s0">;</span><span class="s1"> 
    </span><span class="s0">private </span><span class="s1">ImageButton mRecordImageButton</span><span class="s0">;</span><span class="s1"> 
    </span><span class="s0">private </span><span class="s1">ImageButton mStillImageButton</span><span class="s0">;</span><span class="s1"> 
    </span><span class="s0">private </span><span class="s1">File mVideoFile</span><span class="s0">;</span><span class="s1"> 
    </span><span class="s0">private </span><span class="s1">String mVideoFileName</span><span class="s0">;</span><span class="s1"> 
    </span><span class="s0">private </span><span class="s1">File mImageFile</span><span class="s0">;</span><span class="s1"> 
    </span><span class="s0">private </span><span class="s1">String mImageFileName</span><span class="s0">;</span><span class="s1"> 
    </span><span class="s0">boolean </span><span class="s1">isRecording=</span><span class="s0">false;</span><span class="s1"> 
    </span><span class="s0">private </span><span class="s1">Size previewSize</span><span class="s0">;</span><span class="s1"> 
    </span><span class="s0">private </span><span class="s1">Size mVideoSize</span><span class="s0">;</span><span class="s1"> 
    </span><span class="s0">private </span><span class="s1">Size mImageSize</span><span class="s0">;</span><span class="s1"> 
    </span><span class="s0">private </span><span class="s1">ImageReader mImageReader</span><span class="s0">;</span><span class="s1"> 
    </span><span class="s0">private final </span><span class="s1">ImageReader.OnImageAvailableListener mOnImageAvailableListener=</span><span class="s0">new </span><span class="s1">ImageReader.OnImageAvailableListener() { 
        @Override 
        </span><span class="s0">public void </span><span class="s1">onImageAvailable(ImageReader imageReader) { 
            handler.post(</span><span class="s0">new </span><span class="s1">ImageSaver(imageReader.acquireLatestImage()))</span><span class="s0">;</span><span class="s1"> 
        } 
    }</span><span class="s0">;</span><span class="s1"> 
 
    </span><span class="s0">int </span><span class="s1">mTotalRotation</span><span class="s0">;</span><span class="s1"> 
    </span><span class="s0">private </span><span class="s1">MediaRecorder mMediaRecorder</span><span class="s0">;</span><span class="s1"> 
    Chronometer mChronometer</span><span class="s0">;</span><span class="s1"> 
    </span><span class="s0">private </span><span class="s1">CameraCaptureSession mPreviewCaptureSession</span><span class="s0">;</span><span class="s1"> 
    </span><span class="s0">private </span><span class="s1">CameraCaptureSession.CaptureCallback mPreviewCaptureCallBack=</span><span class="s0">new </span><span class="s1">CameraCaptureSession.CaptureCallback() { 
        </span><span class="s0">private void </span><span class="s1">process(CaptureResult captureResult){ 
            </span><span class="s0">switch </span><span class="s1">(mCaptureState){ 
                </span><span class="s0">case </span><span class="s1">STATE_PREVIEW: 
                    </span><span class="s3">//Do nothing</span><span class="s1"> 
                    </span><span class="s0">break;</span><span class="s1"> 
                </span><span class="s0">case </span><span class="s1">STATE_WAIT_LOCK: 
                    mCaptureState=STATE_PREVIEW</span><span class="s0">;</span><span class="s1"> 
                    Integer afState=captureResult.get(CaptureResult.CONTROL_AF_STATE)</span><span class="s0">;</span><span class="s1"> 
                    </span><span class="s0">if </span><span class="s1">(afState==CaptureResult.CONTROL_AF_STATE_FOCUSED_LOCKED|| 
                            afState==CaptureResult.CONTROL_AF_STATE_NOT_FOCUSED_LOCKED){ 
                        Toast.makeText(CameraActivity.</span><span class="s0">this, </span><span class="s4">&quot;AF locked!&quot;</span><span class="s0">, </span><span class="s1">Toast.LENGTH_SHORT).show()</span><span class="s0">;</span><span class="s1"> 
                        startStillCaptureRequest()</span><span class="s0">;</span><span class="s1"> 
                    } 
 
                    </span><span class="s0">break;</span><span class="s1"> 
            } 
        } 
        @Override 
        </span><span class="s0">public void </span><span class="s1">onCaptureCompleted(@NonNull CameraCaptureSession session</span><span class="s0">, </span><span class="s1">@NonNull CaptureRequest request</span><span class="s0">, </span><span class="s1">@NonNull TotalCaptureResult result) { 
            </span><span class="s0">super</span><span class="s1">.onCaptureCompleted(session</span><span class="s0">, </span><span class="s1">request</span><span class="s0">, </span><span class="s1">result)</span><span class="s0">;</span><span class="s1"> 
            process(result)</span><span class="s0">;</span><span class="s1"> 
        } 
    }</span><span class="s0">;</span><span class="s1"> 
    </span><span class="s0">static </span><span class="s1">SparseIntArray ORIENTATIONS=</span><span class="s0">new </span><span class="s1">SparseIntArray()</span><span class="s0">;</span><span class="s1"> 
    </span><span class="s0">static </span><span class="s1">{ 
        ORIENTATIONS.append(Surface.ROTATION_0</span><span class="s0">,</span><span class="s2">0</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
        ORIENTATIONS.append(Surface.ROTATION_90</span><span class="s0">,</span><span class="s2">90</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
        ORIENTATIONS.append(Surface.ROTATION_180</span><span class="s0">,</span><span class="s2">180</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
        ORIENTATIONS.append(Surface.ROTATION_270</span><span class="s0">,</span><span class="s2">270</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
    } 
    CameraDevice.StateCallback stateCallback=</span><span class="s0">new </span><span class="s1">CameraDevice.StateCallback() { 
        @Override 
        </span><span class="s0">public void </span><span class="s1">onOpened(@NonNull CameraDevice cameraDevice) { 
            mCameraDevice=cameraDevice</span><span class="s0">;</span><span class="s1"> 
            </span><span class="s0">try </span><span class="s1">{ 
                createVideoFileName()</span><span class="s0">;</span><span class="s1"> 
                createImageFileName()</span><span class="s0">;</span><span class="s1"> 
            } </span><span class="s0">catch </span><span class="s1">(IOException e) { 
                e.printStackTrace()</span><span class="s0">;</span><span class="s1"> 
            } 
            startPreview()</span><span class="s0">;</span><span class="s1"> 
        } 
 
        @Override 
        </span><span class="s0">public void </span><span class="s1">onDisconnected(@NonNull CameraDevice cameraDevice) { 
            cameraDevice.close()</span><span class="s0">;</span><span class="s1"> 
            mCameraDevice=</span><span class="s0">null;</span><span class="s1"> 
        } 
 
        @Override 
        </span><span class="s0">public void </span><span class="s1">onError(@NonNull CameraDevice cameraDevice</span><span class="s0">, int </span><span class="s1">i) { 
            cameraDevice.close()</span><span class="s0">;</span><span class="s1"> 
            mCameraDevice=</span><span class="s0">null;</span><span class="s1"> 
        } 
    }</span><span class="s0">;</span><span class="s1"> 
    </span><span class="s0">private void </span><span class="s1">marchResource(){ 
        btn_OpenCamera=findViewById(R.id.btn_OpenCamera)</span><span class="s0">;</span><span class="s1"> 
        textureView =findViewById(R.id.textureView)</span><span class="s0">;</span><span class="s1"> 
        mRecordImageButton=findViewById(R.id.btn_record)</span><span class="s0">;</span><span class="s1"> 
        mChronometer=findViewById(R.id.chronometer)</span><span class="s0">;</span><span class="s1"> 
        mStillImageButton=findViewById(R.id.btn_Capture_Image)</span><span class="s0">;</span><span class="s1"> 
    } 
    @Override 
    </span><span class="s0">protected void </span><span class="s1">onCreate(Bundle savedInstanceState) { 
        </span><span class="s0">super</span><span class="s1">.onCreate(savedInstanceState)</span><span class="s0">;</span><span class="s1"> 
        setContentView(R.layout.activity_camera)</span><span class="s0">;</span><span class="s1"> 
        marchResource()</span><span class="s0">;</span><span class="s1"> 
        createVideoFolder()</span><span class="s0">;</span><span class="s1"> 
        createImageFolder()</span><span class="s0">;</span><span class="s1"> 
        mMediaRecorder=</span><span class="s0">new </span><span class="s1">MediaRecorder()</span><span class="s0">;</span><span class="s1"> 
        mStillImageButton.setOnClickListener(</span><span class="s0">new </span><span class="s1">View.OnClickListener() { 
            @Override 
            </span><span class="s0">public void </span><span class="s1">onClick(View view) { 
                </span><span class="s0">if </span><span class="s1">(mCameraDevice!=</span><span class="s0">null</span><span class="s1">){ 
                    lockFocus()</span><span class="s0">;</span><span class="s1"> 
                }</span><span class="s0">else</span><span class="s1">{ 
                    Toast.makeText(CameraActivity.</span><span class="s0">this, </span><span class="s4">&quot;Open Camera first!&quot;</span><span class="s0">, </span><span class="s1">Toast.LENGTH_SHORT).show()</span><span class="s0">;</span><span class="s1"> 
                } 
 
            } 
        })</span><span class="s0">;</span><span class="s1"> 
        mRecordImageButton.setOnClickListener(</span><span class="s0">new </span><span class="s1">View.OnClickListener() { 
            @Override 
            </span><span class="s0">public void </span><span class="s1">onClick(View view) { 
                </span><span class="s0">if </span><span class="s1">(isRecording){ 
                    mChronometer.stop()</span><span class="s0">;</span><span class="s1"> 
                    mChronometer.setVisibility(View.INVISIBLE)</span><span class="s0">;</span><span class="s1"> 
                    isRecording=</span><span class="s0">false;</span><span class="s1"> 
                    mRecordImageButton.setImageResource(android.R.drawable.presence_video_online)</span><span class="s0">;</span><span class="s1"> 
                    mMediaRecorder.stop()</span><span class="s0">;</span><span class="s1"> 
                    mMediaRecorder.reset()</span><span class="s0">;</span><span class="s1"> 
                    startPreview()</span><span class="s0">;</span><span class="s1"> 
                }</span><span class="s0">else</span><span class="s1">{ 
                    checkWriteStoragePermission()</span><span class="s0">;</span><span class="s1"> 
                } 
            } 
        })</span><span class="s0">;</span><span class="s1"> 
        btn_OpenCamera.setOnClickListener(</span><span class="s0">new </span><span class="s1">View.OnClickListener() { 
            @Override 
            </span><span class="s0">public void </span><span class="s1">onClick(View view) { 
                </span><span class="s0">if </span><span class="s1">(mCameraDevice==</span><span class="s0">null</span><span class="s1">){ 
                    setupCamera(textureView.getWidth()</span><span class="s0">,</span><span class="s1">textureView.getHeight())</span><span class="s0">;</span><span class="s1"> 
                }</span><span class="s0">else</span><span class="s1">{ 
                    closeCamera()</span><span class="s0">;</span><span class="s1"> 
                } 
 
            } 
        })</span><span class="s0">;</span><span class="s1"> 
 
    } 
 
    @Override 
    </span><span class="s0">protected void </span><span class="s1">onResume() { 
        </span><span class="s0">super</span><span class="s1">.onResume()</span><span class="s0">;</span><span class="s1"> 
        startBackGroundThread()</span><span class="s0">;</span><span class="s1"> 
    } 
 
    @Override 
    </span><span class="s0">protected void </span><span class="s1">onPause() { 
        </span><span class="s0">super</span><span class="s1">.onPause()</span><span class="s0">;</span><span class="s1"> 
        stopBackgroundThread()</span><span class="s0">;</span><span class="s1"> 
    } 
 
    </span><span class="s0">public void </span><span class="s1">setupCamera(</span><span class="s0">int </span><span class="s1">width</span><span class="s0">, int </span><span class="s1">height){ 
        cameraManager= (CameraManager) getSystemService(Context.CAMERA_SERVICE)</span><span class="s0">;</span><span class="s1"> 
        </span><span class="s0">try </span><span class="s1">{ 
            </span><span class="s0">for </span><span class="s1">(String cameraId:cameraManager.getCameraIdList()){ 
                CameraCharacteristics cameraCharacteristics=cameraManager.getCameraCharacteristics(cameraId)</span><span class="s0">;</span><span class="s1"> 
                </span><span class="s0">if </span><span class="s1">(cameraCharacteristics.get(CameraCharacteristics.LENS_FACING)==CameraCharacteristics.LENS_FACING_FRONT){ 
                    </span><span class="s0">continue;</span><span class="s1"> 
                } 
                StreamConfigurationMap map=cameraCharacteristics.get(CameraCharacteristics.SCALER_STREAM_CONFIGURATION_MAP)</span><span class="s0">;</span><span class="s1"> 
                </span><span class="s0">int </span><span class="s1">deviceOrientation=getWindowManager().getDefaultDisplay().getRotation()</span><span class="s0">;</span><span class="s1"> 
                mTotalRotation=sensorToDeviceRotation(cameraCharacteristics</span><span class="s0">,</span><span class="s1">deviceOrientation)</span><span class="s0">;</span><span class="s1"> 
                </span><span class="s0">boolean </span><span class="s1">swapRotation=mTotalRotation==</span><span class="s2">90</span><span class="s1">||mTotalRotation==</span><span class="s2">270</span><span class="s0">;</span><span class="s1"> 
                </span><span class="s0">int </span><span class="s1">rotatedWidth=width</span><span class="s0">;</span><span class="s1"> 
                </span><span class="s0">int </span><span class="s1">rotatedHeight=height</span><span class="s0">;</span><span class="s1"> 
                </span><span class="s0">if </span><span class="s1">(swapRotation){ 
                    rotatedWidth=height</span><span class="s0">;</span><span class="s1"> 
                    rotatedHeight=width</span><span class="s0">;</span><span class="s1"> 
                } 
                previewSize=chooseOptimalSize(map.getOutputSizes(SurfaceTexture.</span><span class="s0">class</span><span class="s1">)</span><span class="s0">,</span><span class="s1">rotatedWidth</span><span class="s0">,</span><span class="s1">rotatedHeight)</span><span class="s0">;</span><span class="s1"> 
                mVideoSize=chooseOptimalSize(map.getOutputSizes(MediaRecorder.</span><span class="s0">class</span><span class="s1">)</span><span class="s0">,</span><span class="s1">rotatedWidth</span><span class="s0">,</span><span class="s1">rotatedHeight)</span><span class="s0">;</span><span class="s1"> 
                mImageSize=chooseOptimalSize(map.getOutputSizes(ImageFormat.JPEG)</span><span class="s0">,</span><span class="s1">rotatedWidth</span><span class="s0">,</span><span class="s1">rotatedHeight)</span><span class="s0">;</span><span class="s1"> 
                mImageReader=ImageReader.newInstance(mImageSize.getWidth()</span><span class="s0">,</span><span class="s1">mImageSize.getHeight()</span><span class="s0">,</span><span class="s1">ImageFormat.JPEG</span><span class="s0">,</span><span class="s2">1</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
                mImageReader.setOnImageAvailableListener(mOnImageAvailableListener</span><span class="s0">,</span><span class="s1">handler)</span><span class="s0">;</span><span class="s1"> 
                mCameraID=cameraId</span><span class="s0">;</span><span class="s1"> 
                connectCamera()</span><span class="s0">;</span><span class="s1"> 
                </span><span class="s0">return;</span><span class="s1"> 
            } 
        } </span><span class="s0">catch </span><span class="s1">(CameraAccessException e) { 
            e.printStackTrace()</span><span class="s0">;</span><span class="s1"> 
        } 
 
    } 
    </span><span class="s0">private void </span><span class="s1">startRecord(){ 
        </span><span class="s0">try </span><span class="s1">{ 
            setupMediaRecorder()</span><span class="s0">;</span><span class="s1"> 
            SurfaceTexture surfaceTexture=textureView.getSurfaceTexture()</span><span class="s0">;</span><span class="s1"> 
            surfaceTexture.setDefaultBufferSize(previewSize.getWidth()</span><span class="s0">,</span><span class="s1">previewSize.getHeight())</span><span class="s0">;</span><span class="s1"> 
            Surface previewSurface=</span><span class="s0">new </span><span class="s1">Surface(surfaceTexture)</span><span class="s0">;</span><span class="s1"> 
            Surface recordSurface =mMediaRecorder.getSurface()</span><span class="s0">;</span><span class="s1"> 
            captureRequestBuilder=mCameraDevice.createCaptureRequest(CameraDevice.TEMPLATE_RECORD)</span><span class="s0">;</span><span class="s1"> 
            captureRequestBuilder.addTarget(previewSurface)</span><span class="s0">;</span><span class="s1"> 
            captureRequestBuilder.addTarget(recordSurface)</span><span class="s0">;</span><span class="s1"> 
            mCameraDevice.createCaptureSession(Arrays.asList(previewSurface</span><span class="s0">, </span><span class="s1">recordSurface)</span><span class="s0">, new </span><span class="s1">CameraCaptureSession.StateCallback() { 
                @Override 
                </span><span class="s0">public void </span><span class="s1">onConfigured(@NonNull CameraCaptureSession cameraCaptureSession) { 
                    </span><span class="s0">try </span><span class="s1">{ 
                        cameraCaptureSession.setRepeatingRequest(captureRequestBuilder.build()</span><span class="s0">,null,null</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
                    } </span><span class="s0">catch </span><span class="s1">(CameraAccessException e) { 
                        e.printStackTrace()</span><span class="s0">;</span><span class="s1"> 
                    } 
                } 
 
                @Override 
                </span><span class="s0">public void </span><span class="s1">onConfigureFailed(@NonNull CameraCaptureSession cameraCaptureSession) { 
 
                } 
            }</span><span class="s0">,null</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
 
        } </span><span class="s0">catch </span><span class="s1">(IOException e) { 
            e.printStackTrace()</span><span class="s0">;</span><span class="s1"> 
        } </span><span class="s0">catch </span><span class="s1">(CameraAccessException e) { 
            e.printStackTrace()</span><span class="s0">;</span><span class="s1"> 
        } 
    } 
    </span><span class="s0">private void </span><span class="s1">startPreview(){ 
        SurfaceTexture surfaceTexture=textureView.getSurfaceTexture()</span><span class="s0">;</span><span class="s1"> 
        surfaceTexture.setDefaultBufferSize(previewSize.getWidth()</span><span class="s0">,</span><span class="s1">previewSize.getHeight())</span><span class="s0">;</span><span class="s1"> 
        Surface previewSurface=</span><span class="s0">new </span><span class="s1">Surface(surfaceTexture)</span><span class="s0">;</span><span class="s1"> 
        </span><span class="s0">try </span><span class="s1">{ 
            captureRequestBuilder=mCameraDevice.createCaptureRequest(CameraDevice.TEMPLATE_PREVIEW)</span><span class="s0">;</span><span class="s1"> 
            captureRequestBuilder.addTarget(previewSurface)</span><span class="s0">;</span><span class="s1"> 
            mCameraDevice.createCaptureSession(Arrays.asList(previewSurface</span><span class="s0">,</span><span class="s1">mImageReader.getSurface())</span><span class="s0">, new </span><span class="s1">CameraCaptureSession.StateCallback() { 
                @Override 
                </span><span class="s0">public void </span><span class="s1">onConfigured(@NonNull CameraCaptureSession cameraCaptureSession) { 
                    mPreviewCaptureSession=cameraCaptureSession</span><span class="s0">;</span><span class="s1"> 
                    </span><span class="s0">try </span><span class="s1">{ 
                        mPreviewCaptureSession.setRepeatingRequest(captureRequestBuilder.build()</span><span class="s0">,null,</span><span class="s1">handler)</span><span class="s0">;</span><span class="s1"> 
                    } </span><span class="s0">catch </span><span class="s1">(CameraAccessException e) { 
                        e.printStackTrace()</span><span class="s0">;</span><span class="s1"> 
                    } 
                } 
                @Override 
                </span><span class="s0">public void </span><span class="s1">onConfigureFailed(@NonNull CameraCaptureSession cameraCaptureSession) { 
                    Toast.makeText(CameraActivity.</span><span class="s0">this, </span><span class="s4">&quot;Unable to setup camera preview&quot;</span><span class="s0">, </span><span class="s1">Toast.LENGTH_SHORT).show()</span><span class="s0">;</span><span class="s1"> 
                } 
            }</span><span class="s0">,</span><span class="s1">handler)</span><span class="s0">;</span><span class="s1"> 
        } </span><span class="s0">catch </span><span class="s1">(CameraAccessException e) { 
            e.printStackTrace()</span><span class="s0">;</span><span class="s1"> 
        } 
 
    } 
    </span><span class="s0">private void </span><span class="s1">stopPreview(){ 
        SurfaceTexture surfaceTexture=textureView.getSurfaceTexture()</span><span class="s0">;</span><span class="s1"> 
        Surface surface=</span><span class="s0">new </span><span class="s1">Surface(surfaceTexture)</span><span class="s0">;</span><span class="s1"> 
        surface.release()</span><span class="s0">;</span><span class="s1"> 
 
    } 
 
    @Override 
    </span><span class="s0">public void </span><span class="s1">onRequestPermissionsResult(</span><span class="s0">int </span><span class="s1">requestCode</span><span class="s0">, </span><span class="s1">@NonNull String[] permissions</span><span class="s0">, </span><span class="s1">@NonNull </span><span class="s0">int</span><span class="s1">[] grantResults) { 
        </span><span class="s0">super</span><span class="s1">.onRequestPermissionsResult(requestCode</span><span class="s0">, </span><span class="s1">permissions</span><span class="s0">, </span><span class="s1">grantResults)</span><span class="s0">;</span><span class="s1"> 
        </span><span class="s0">if </span><span class="s1">(requestCode==REQUEST_CAMERA_PERMISSION_RESULT){ 
            </span><span class="s0">if </span><span class="s1">(grantResults[</span><span class="s2">0</span><span class="s1">]!=PackageManager.PERMISSION_GRANTED){ 
                Toast.makeText(</span><span class="s0">this, </span><span class="s4">&quot;Appication will not run without Camera services&quot;</span><span class="s0">, </span><span class="s1">Toast.LENGTH_SHORT).show()</span><span class="s0">;</span><span class="s1"> 
            } 
        } 
        </span><span class="s0">if </span><span class="s1">(requestCode==REQUEST_WRITE_EXTENAL_STORAGE_PERMISSION_RESULT){ 
            </span><span class="s0">if </span><span class="s1">(grantResults[</span><span class="s2">0</span><span class="s1">]==PackageManager.PERMISSION_GRANTED){ 
                isRecording=</span><span class="s0">true;</span><span class="s1"> 
                mRecordImageButton.setImageResource(android.R.drawable.presence_video_busy)</span><span class="s0">;</span><span class="s1"> 
                </span><span class="s0">try </span><span class="s1">{ 
                    createVideoFileName()</span><span class="s0">;</span><span class="s1"> 
                } </span><span class="s0">catch </span><span class="s1">(IOException e) { 
                    e.printStackTrace()</span><span class="s0">;</span><span class="s1"> 
                } 
            }</span><span class="s0">else</span><span class="s1">{ 
                Toast.makeText(</span><span class="s0">this, </span><span class="s4">&quot;Appication need to write extenal Storage to save video&quot;</span><span class="s0">, </span><span class="s1">Toast.LENGTH_SHORT).show()</span><span class="s0">;</span><span class="s1"> 
 
            } 
        } 
    } 
    </span><span class="s0">private void </span><span class="s1">closeCamera(){ 
        mCameraDevice.close()</span><span class="s0">;</span><span class="s1"> 
        mCameraDevice=</span><span class="s0">null;</span><span class="s1"> 
        btn_OpenCamera.setText(</span><span class="s4">&quot;Open Camera&quot;</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
        stopPreview()</span><span class="s0">;</span><span class="s1"> 
    } 
    </span><span class="s0">private void </span><span class="s1">connectCamera(){ 
        cameraManager= (CameraManager) getSystemService(Context.CAMERA_SERVICE)</span><span class="s0">;</span><span class="s1"> 
        </span><span class="s0">try </span><span class="s1">{ 
            </span><span class="s0">if </span><span class="s1">(Build.VERSION.SDK_INT&gt;=Build.VERSION_CODES.M){ 
                </span><span class="s0">if </span><span class="s1">(ContextCompat.checkSelfPermission(</span><span class="s0">this, </span><span class="s1">Manifest.permission.CAMERA) 
                        == PackageManager.PERMISSION_GRANTED){ 
                    cameraManager.openCamera(mCameraID</span><span class="s0">,</span><span class="s1">stateCallback</span><span class="s0">,</span><span class="s1">handler)</span><span class="s0">;</span><span class="s1"> 
                    btn_OpenCamera.setText(</span><span class="s4">&quot;Close Camera&quot;</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
                }</span><span class="s0">else</span><span class="s1">{ 
                    </span><span class="s0">if </span><span class="s1">(shouldShowRequestPermissionRationale(Manifest.permission.CAMERA)){ 
 
                    } 
                    requestPermissions(</span><span class="s0">new </span><span class="s1">String[]{Manifest.permission.CAMERA}</span><span class="s0">,</span><span class="s1">REQUEST_CAMERA_PERMISSION_RESULT)</span><span class="s0">;</span><span class="s1"> 
                } 
            }</span><span class="s0">else</span><span class="s1">{ 
                cameraManager.openCamera(mCameraID</span><span class="s0">,</span><span class="s1">stateCallback</span><span class="s0">,</span><span class="s1">handler)</span><span class="s0">;</span><span class="s1"> 
                btn_OpenCamera.setText(</span><span class="s4">&quot;Close Camera&quot;</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
            } 
        } </span><span class="s0">catch </span><span class="s1">(CameraAccessException e) { 
            e.printStackTrace()</span><span class="s0">;</span><span class="s1"> 
        } 
    } 
    </span><span class="s0">public void </span><span class="s1">startBackGroundThread(){ 
        handlerThread=</span><span class="s0">new </span><span class="s1">HandlerThread(</span><span class="s4">&quot;LiveEduSupporter&quot;</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
        handlerThread.start()</span><span class="s0">;</span><span class="s1"> 
        handler=</span><span class="s0">new </span><span class="s1">Handler(handlerThread.getLooper())</span><span class="s0">;</span><span class="s1"> 
 
    } 
    </span><span class="s0">public void </span><span class="s1">stopBackgroundThread(){ 
        handlerThread.quitSafely()</span><span class="s0">;</span><span class="s1"> 
        </span><span class="s0">try </span><span class="s1">{ 
            handlerThread.join()</span><span class="s0">;</span><span class="s1"> 
            handlerThread=</span><span class="s0">null;</span><span class="s1"> 
            handler=</span><span class="s0">null;</span><span class="s1"> 
        } </span><span class="s0">catch </span><span class="s1">(InterruptedException e) { 
            e.printStackTrace()</span><span class="s0">;</span><span class="s1"> 
        } 
    } 
    </span><span class="s0">private int </span><span class="s1">sensorToDeviceRotation(CameraCharacteristics cameraCharacteristics</span><span class="s0">,int </span><span class="s1">deviceOrientaion){ 
        </span><span class="s0">int </span><span class="s1">sensorOrientation=cameraCharacteristics.get(CameraCharacteristics.SENSOR_ORIENTATION)</span><span class="s0">;</span><span class="s1"> 
        deviceOrientaion=ORIENTATIONS.get(deviceOrientaion)</span><span class="s0">;</span><span class="s1"> 
        </span><span class="s0">return </span><span class="s1">(sensorOrientation+deviceOrientaion+</span><span class="s2">360</span><span class="s1">)%</span><span class="s2">360</span><span class="s0">;</span><span class="s1"> 
    } 
    </span><span class="s0">private static class </span><span class="s1">CompareSizeByArea </span><span class="s0">implements </span><span class="s1">Comparator&lt;Size&gt;{ 
 
        @Override 
        </span><span class="s0">public int </span><span class="s1">compare(Size size</span><span class="s0">, </span><span class="s1">Size t1) { 
            </span><span class="s0">return </span><span class="s1">Long.signum(size.getWidth()*size.getHeight()/(t1.getWidth()*t1.getHeight()))</span><span class="s0">;</span><span class="s1"> 
        } 
    } 
    </span><span class="s0">private static </span><span class="s1">Size chooseOptimalSize(Size[] choices</span><span class="s0">,int </span><span class="s1">width</span><span class="s0">,int </span><span class="s1">height){ 
        List&lt;Size&gt; bigEnough=</span><span class="s0">new </span><span class="s1">ArrayList&lt;&gt;()</span><span class="s0">;</span><span class="s1"> 
        </span><span class="s0">for</span><span class="s1">(Size option:choices){ 
            </span><span class="s0">if </span><span class="s1">(option.getHeight()==option.getWidth()*height/width&amp;&amp; 
                    option.getWidth()&gt;=width&amp;&amp;option.getHeight()&gt;=height){ 
                bigEnough.add(option)</span><span class="s0">;</span><span class="s1"> 
            } 
 
        } 
        </span><span class="s0">if </span><span class="s1">(bigEnough.size()&gt;</span><span class="s2">0</span><span class="s1">){ 
            </span><span class="s0">return </span><span class="s1">Collections.min(bigEnough</span><span class="s0">,new </span><span class="s1">CompareSizeByArea())</span><span class="s0">;</span><span class="s1"> 
        }</span><span class="s0">else</span><span class="s1">{ 
            </span><span class="s0">return </span><span class="s1">choices[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">;</span><span class="s1"> 
        } 
    } 
    </span><span class="s0">private void </span><span class="s1">createImageFolder(){ 
        File imageFolder= Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_PICTURES)</span><span class="s0">;</span><span class="s1"> 
        </span><span class="s0">if </span><span class="s1">(!imageFolder.exists()){ 
            imageFolder.mkdir()</span><span class="s0">;</span><span class="s1"> 
        } 
        mImageFile=</span><span class="s0">new </span><span class="s1">File(imageFolder</span><span class="s0">,</span><span class="s4">&quot;LiveEduSupporter&quot;</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
        </span><span class="s0">if </span><span class="s1">(Environment.getExternalStorageState().equals(Environment.MEDIA_MOUNTED)){ 
            </span><span class="s0">if </span><span class="s1">(!mImageFile.exists()){ 
                </span><span class="s0">if </span><span class="s1">(!mImageFile.mkdir()){ 
                    </span><span class="s0">try </span><span class="s1">{ 
                        mImageFile.createNewFile()</span><span class="s0">;</span><span class="s1"> 
                    } </span><span class="s0">catch </span><span class="s1">(IOException e) { 
                        e.printStackTrace()</span><span class="s0">;</span><span class="s1"> 
                    } 
                } 
            } 
        }</span><span class="s0">else</span><span class="s1">{ 
            Toast.makeText(</span><span class="s0">this, </span><span class="s4">&quot;Cant read external Storage&quot;</span><span class="s0">, </span><span class="s1">Toast.LENGTH_SHORT).show()</span><span class="s0">;</span><span class="s1"> 
        } 
 
    } 
    </span><span class="s0">private </span><span class="s1">File createImageFileName() </span><span class="s0">throws </span><span class="s1">IOException { 
        String timeStamp=</span><span class="s0">new </span><span class="s1">SimpleDateFormat(</span><span class="s4">&quot;HHmmss_ddMMyyyy&quot;</span><span class="s1">).format(</span><span class="s0">new </span><span class="s1">Date())</span><span class="s0">;</span><span class="s1"> 
        String prepend=</span><span class="s4">&quot;IMAGE_&quot;</span><span class="s1">+timeStamp+</span><span class="s4">&quot;_&quot;</span><span class="s0">;</span><span class="s1"> 
        File imageFile=File.createTempFile(prepend</span><span class="s0">,</span><span class="s4">&quot;.jpg&quot;</span><span class="s0">,</span><span class="s1">mImageFile)</span><span class="s0">;</span><span class="s1"> 
        </span><span class="s0">if </span><span class="s1">(!imageFile.exists()){ 
            imageFile.mkdir()</span><span class="s0">;</span><span class="s1"> 
        } 
 
        mImageFileName=imageFile.getAbsolutePath()</span><span class="s0">;</span><span class="s1"> 
        </span><span class="s0">return  </span><span class="s1">imageFile</span><span class="s0">;</span><span class="s1"> 
    } 
    </span><span class="s0">private void </span><span class="s1">createVideoFolder(){ 
        File videoFolder= Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_MOVIES)</span><span class="s0">;</span><span class="s1"> 
        </span><span class="s0">if </span><span class="s1">(!videoFolder.exists()){ 
            videoFolder.mkdir()</span><span class="s0">;</span><span class="s1"> 
        } 
        mVideoFile=</span><span class="s0">new </span><span class="s1">File(videoFolder</span><span class="s0">,</span><span class="s4">&quot;LiveEduSupporter&quot;</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
        </span><span class="s0">if </span><span class="s1">(Environment.getExternalStorageState().equals(Environment.MEDIA_MOUNTED)){ 
            </span><span class="s0">if </span><span class="s1">(!mVideoFile.exists()){ 
                </span><span class="s0">if </span><span class="s1">(!mVideoFile.mkdir()){ 
                    </span><span class="s0">try </span><span class="s1">{ 
                        mVideoFile.createNewFile()</span><span class="s0">;</span><span class="s1"> 
                    } </span><span class="s0">catch </span><span class="s1">(IOException e) { 
                        e.printStackTrace()</span><span class="s0">;</span><span class="s1"> 
                    } 
                } 
            } 
        }</span><span class="s0">else</span><span class="s1">{ 
            Toast.makeText(</span><span class="s0">this, </span><span class="s4">&quot;Cant read external Storage&quot;</span><span class="s0">, </span><span class="s1">Toast.LENGTH_SHORT).show()</span><span class="s0">;</span><span class="s1"> 
        } 
 
    } 
    </span><span class="s0">private </span><span class="s1">File createVideoFileName() </span><span class="s0">throws </span><span class="s1">IOException { 
        String timeStamp=</span><span class="s0">new </span><span class="s1">SimpleDateFormat(</span><span class="s4">&quot;HHmmss_ddMMyyyy&quot;</span><span class="s1">).format(</span><span class="s0">new </span><span class="s1">Date())</span><span class="s0">;</span><span class="s1"> 
        String prepend=</span><span class="s4">&quot;VIDEO_&quot;</span><span class="s1">+timeStamp+</span><span class="s4">&quot;_&quot;</span><span class="s0">;</span><span class="s1"> 
        File videoFile=File.createTempFile(prepend</span><span class="s0">,</span><span class="s4">&quot;.mp4&quot;</span><span class="s0">,</span><span class="s1">mVideoFile)</span><span class="s0">;</span><span class="s1"> 
        </span><span class="s0">if </span><span class="s1">(!videoFile.exists()){ 
            videoFile.mkdir()</span><span class="s0">;</span><span class="s1"> 
        } 
 
        mVideoFileName=videoFile.getAbsolutePath()</span><span class="s0">;</span><span class="s1"> 
        </span><span class="s0">return  </span><span class="s1">videoFile</span><span class="s0">;</span><span class="s1"> 
    } 
    </span><span class="s0">private void </span><span class="s1">recordingVideo(){ 
        isRecording=</span><span class="s0">true;</span><span class="s1"> 
        mRecordImageButton.setImageResource(android.R.drawable.presence_video_busy)</span><span class="s0">;</span><span class="s1"> 
        </span><span class="s0">try </span><span class="s1">{ 
            createVideoFileName()</span><span class="s0">;</span><span class="s1"> 
        } </span><span class="s0">catch </span><span class="s1">(IOException e) { 
            e.printStackTrace()</span><span class="s0">;</span><span class="s1"> 
        } 
        startRecord()</span><span class="s0">;</span><span class="s1"> 
        mMediaRecorder.start()</span><span class="s0">;</span><span class="s1"> 
        mChronometer.setBase(SystemClock.elapsedRealtime())</span><span class="s0">;</span><span class="s1"> 
        mChronometer.setVisibility(View.VISIBLE)</span><span class="s0">;</span><span class="s1"> 
        mChronometer.start()</span><span class="s0">;</span><span class="s1"> 
    } 
    </span><span class="s0">private void </span><span class="s1">checkWriteStoragePermission(){ 
        </span><span class="s0">if </span><span class="s1">(mCameraDevice!=</span><span class="s0">null</span><span class="s1">){ 
            </span><span class="s0">if </span><span class="s1">(Build.VERSION.SDK_INT&gt;=Build.VERSION_CODES.M){ 
                </span><span class="s0">if </span><span class="s1">(ContextCompat.checkSelfPermission(</span><span class="s0">this,</span><span class="s1">Manifest.permission.WRITE_EXTERNAL_STORAGE)== 
                        PackageManager.PERMISSION_GRANTED){ 
                    recordingVideo()</span><span class="s0">;</span><span class="s1"> 
                }</span><span class="s0">else</span><span class="s1">{ 
                    </span><span class="s0">if </span><span class="s1">(shouldShowRequestPermissionRationale(Manifest.permission.WRITE_EXTERNAL_STORAGE)){ 
                        Toast.makeText(</span><span class="s0">this, </span><span class="s4">&quot;app needs to be able to save videos.&quot;</span><span class="s0">, </span><span class="s1">Toast.LENGTH_SHORT).show()</span><span class="s0">;</span><span class="s1"> 
                    } 
                    requestPermissions(</span><span class="s0">new </span><span class="s1">String[]{Manifest.permission.WRITE_EXTERNAL_STORAGE}</span><span class="s0">,</span><span class="s1">REQUEST_WRITE_EXTENAL_STORAGE_PERMISSION_RESULT)</span><span class="s0">;</span><span class="s1"> 
                } 
            }</span><span class="s0">else</span><span class="s1">{ 
                recordingVideo()</span><span class="s0">;</span><span class="s1"> 
            } 
        }</span><span class="s0">else</span><span class="s1">{ 
            Toast.makeText(</span><span class="s0">this, </span><span class="s4">&quot;Open camera first!&quot;</span><span class="s0">, </span><span class="s1">Toast.LENGTH_SHORT).show()</span><span class="s0">;</span><span class="s1"> 
        } 
 
    } 
    </span><span class="s0">private void </span><span class="s1">setupMediaRecorder() </span><span class="s0">throws </span><span class="s1">IOException { 
        mMediaRecorder.setVideoSource(MediaRecorder.VideoSource.SURFACE)</span><span class="s0">;</span><span class="s1"> 
        mMediaRecorder.setOutputFormat(MediaRecorder.OutputFormat.MPEG_4)</span><span class="s0">;</span><span class="s1"> 
        mMediaRecorder.setOutputFile(mVideoFileName)</span><span class="s0">;</span><span class="s1"> 
        mMediaRecorder.setAudioEncodingBitRate(</span><span class="s2">1000000</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
        mMediaRecorder.setVideoFrameRate(</span><span class="s2">30</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
        mMediaRecorder.setVideoSize(mVideoSize.getWidth()</span><span class="s0">,</span><span class="s1">mVideoSize.getHeight())</span><span class="s0">;</span><span class="s1"> 
        mMediaRecorder.setVideoEncoder(MediaRecorder.VideoEncoder.H264)</span><span class="s0">;</span><span class="s1"> 
        mMediaRecorder.setOrientationHint(mTotalRotation)</span><span class="s0">;</span><span class="s1"> 
        mMediaRecorder.prepare()</span><span class="s0">;</span><span class="s1"> 
 
    } 
    </span><span class="s0">private void </span><span class="s1">lockFocus(){ 
        mCaptureState=STATE_WAIT_LOCK</span><span class="s0">;</span><span class="s1"> 
        captureRequestBuilder.set(CaptureRequest.CONTROL_AF_TRIGGER</span><span class="s0">,</span><span class="s1">CaptureRequest.CONTROL_AF_TRIGGER_START)</span><span class="s0">;</span><span class="s1"> 
        </span><span class="s0">try </span><span class="s1">{ 
            mPreviewCaptureSession.capture(captureRequestBuilder.build()</span><span class="s0">,</span><span class="s1">mPreviewCaptureCallBack</span><span class="s0">,</span><span class="s1">handler)</span><span class="s0">;</span><span class="s1"> 
        } </span><span class="s0">catch </span><span class="s1">(CameraAccessException e) { 
            e.printStackTrace()</span><span class="s0">;</span><span class="s1"> 
        } 
    } 
    </span><span class="s0">private void </span><span class="s1">startStillCaptureRequest(){ 
        </span><span class="s0">try </span><span class="s1">{ 
            captureRequestBuilder=mCameraDevice.createCaptureRequest(CameraDevice.TEMPLATE_STILL_CAPTURE)</span><span class="s0">;</span><span class="s1"> 
            captureRequestBuilder.addTarget(mImageReader.getSurface())</span><span class="s0">;</span><span class="s1"> 
            captureRequestBuilder.set(CaptureRequest.JPEG_ORIENTATION</span><span class="s0">,</span><span class="s1">mTotalRotation)</span><span class="s0">;</span><span class="s1"> 
            CameraCaptureSession.CaptureCallback stillCaptureCallBack=</span><span class="s0">new </span><span class="s1">CameraCaptureSession.CaptureCallback() { 
                @Override 
                </span><span class="s0">public void </span><span class="s1">onCaptureStarted(@NonNull CameraCaptureSession session</span><span class="s0">, </span><span class="s1">@NonNull CaptureRequest request</span><span class="s0">, long </span><span class="s1">timestamp</span><span class="s0">, long </span><span class="s1">frameNumber) { 
                    </span><span class="s0">super</span><span class="s1">.onCaptureStarted(session</span><span class="s0">, </span><span class="s1">request</span><span class="s0">, </span><span class="s1">timestamp</span><span class="s0">, </span><span class="s1">frameNumber)</span><span class="s0">;</span><span class="s1"> 
                    </span><span class="s0">try </span><span class="s1">{ 
                        createImageFileName()</span><span class="s0">;</span><span class="s1"> 
                    } </span><span class="s0">catch </span><span class="s1">(IOException e) { 
                        e.printStackTrace()</span><span class="s0">;</span><span class="s1"> 
                    } 
                } 
            }</span><span class="s0">;</span><span class="s1"> 
            mPreviewCaptureSession.capture(captureRequestBuilder.build()</span><span class="s0">,</span><span class="s1">stillCaptureCallBack</span><span class="s0">,</span><span class="s1">handler)</span><span class="s0">;</span><span class="s1"> 
 
        } </span><span class="s0">catch </span><span class="s1">(CameraAccessException e) { 
            e.printStackTrace()</span><span class="s0">;</span><span class="s1"> 
        } 
    } 
    </span><span class="s0">private class </span><span class="s1">ImageSaver </span><span class="s0">implements </span><span class="s1">Runnable{ 
        </span><span class="s0">private final </span><span class="s1">Image mImage</span><span class="s0">;</span><span class="s1"> 
 
        </span><span class="s0">private </span><span class="s1">ImageSaver(Image mImage) { 
            </span><span class="s0">this</span><span class="s1">.mImage = mImage</span><span class="s0">;</span><span class="s1"> 
        } 
 
        @Override 
        </span><span class="s0">public void </span><span class="s1">run() { 
            ByteBuffer byteBuffer=mImage.getPlanes()[</span><span class="s2">0</span><span class="s1">].getBuffer()</span><span class="s0">;</span><span class="s1"> 
            </span><span class="s0">byte</span><span class="s1">[] bytes=</span><span class="s0">new byte</span><span class="s1">[byteBuffer.remaining()]</span><span class="s0">;</span><span class="s1"> 
            byteBuffer.get(bytes)</span><span class="s0">;</span><span class="s1"> 
            FileOutputStream fileOutputStream=</span><span class="s0">null;</span><span class="s1"> 
            </span><span class="s0">try </span><span class="s1">{ 
                fileOutputStream=</span><span class="s0">new </span><span class="s1">FileOutputStream(mImageFileName)</span><span class="s0">;</span><span class="s1"> 
                fileOutputStream.write(bytes)</span><span class="s0">;</span><span class="s1"> 
            } </span><span class="s0">catch </span><span class="s1">(IOException e) { 
                e.printStackTrace()</span><span class="s0">;</span><span class="s1"> 
            }</span><span class="s0">finally </span><span class="s1">{ 
                mImage.close()</span><span class="s0">;</span><span class="s1"> 
                </span><span class="s0">if </span><span class="s1">(fileOutputStream!=</span><span class="s0">null</span><span class="s1">){ 
                    </span><span class="s0">try </span><span class="s1">{ 
                        fileOutputStream.close()</span><span class="s0">;</span><span class="s1"> 
                    } </span><span class="s0">catch </span><span class="s1">(IOException e) { 
                        e.printStackTrace()</span><span class="s0">;</span><span class="s1"> 
                    } 
                } 
            } 
        } 
    } 
 
} 
</span></pre>
</body>
</html>